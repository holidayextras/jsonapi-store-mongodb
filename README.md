[![Coverage Status](https://coveralls.io/repos/holidayextras/jsonapi-store-mongodb/badge.svg?branch=master&service=github)](https://coveralls.io/github/holidayextras/jsonapi-store-mongodb?branch=master)
[![Build Status](https://travis-ci.org/holidayextras/jsonapi-store-mongodb.svg?branch=master)](https://travis-ci.org/holidayextras/jsonapi-store-mongodb)
[![npm version](https://badge.fury.io/js/jsonapi-store-mongodb.svg)](http://badge.fury.io/js/jsonapi-store-mongodb)
[![Code Climate](https://codeclimate.com/github/holidayextras/jsonapi-store-mongodb/badges/gpa.svg)](https://codeclimate.com/github/holidayextras/jsonapi-store-mongodb)
[![Dependencies Status](https://david-dm.org/holidayextras/jsonapi-store-mongodb.svg)](https://david-dm.org/holidayextras/jsonapi-store-mongodb)


# jsonapi-store-mongodb

`jsonapi-store-mongodb` is a MongoDB backed data store for [`jsonapi-server`](https://github.com/holidayextras/jsonapi-server).

This project conforms to the specification laid out in the [jsonapi-server handler documentation](https://github.com/holidayextras/jsonapi-server/blob/master/documentation/handlers.md).


## Changes

This fork has made the following changes:

#### Projection

The config object given to the mongoHandler constructor now supports an optional projection property. This property will cause **all** mongo queries to optionally limit the fields returned in the response. The property value as defined in the config object is passed directly to all mongo queries as the second parameter. For more information, see the [official mongo documentation on the subject](https://docs.mongodb.com/manual/tutorial/project-fields-from-query-results/)

### onCreateSettings

Resource definitions now allows a onCreateSettings property. This object is mapped directly on every newly created object of the resource's type. Use this property in your resource definition if you want every new object to contain a particular predefined value.

*example: Every new object should have a 'isSoftDeleted' flag set to 'false'.*
```
jsonApi.define({
  onCreateSettings: {
    isSoftDeleted: false,
  },
  // rest of definition
});
```

### filterMapper

In case you want to add custom mongo query filtering on every resource, we've added an optional filterMapper property to the resource definition. This filterMapper property expects a function, which in turn expects a *filters* object. This custom filterMapper should return a valid mongo expression, which will be composed together with the mongo expression potentially generated by the standard implementation of jsonapi-store-mongodb. (this expression is, for example, generated when the user adds postprocessing filters to the url as query params)

The filters object optionally expected by the filterMapper function is actually an object defined on a custom property on the headers property of the express request object: `request.headers.extraParams`. You can, in your custom express logic, use this to define additional validations based on authorisation, environment or other such use cases, and pass these parameters to this mongohandler in a decoupled fashion.

*example implementation of a filterMapper, for a resource which should filter out all data for which the isSoftDeleted flag is true, and should only return data whose 'user' property matches the given validUsers in the headers*

*Resource definition:*
```
jsonApi.define({
  filterMapper: (headerParams = {}) => {
    const filter = {
      isSoftDeleted: { $ne: true },
    };

    if (headerParams.users && headerParams.users.length) {
      filter.users = headerParams.users;
    }

    return filter;
  },
  // rest of definition
});
```

*express request object header:*
```
request.headers.extraParams = {
  users: [
    '16ba0196d56df2875a163ade',
    '9799786af7df52663450d621',
  ],
};
```

### validationMapper

The validationMapper follows the exact same idea as the filterMapper, but instead of filtering, it will validate any newly created resource against the given constraints. These constraints take the same form as the returned filter of the filterMapper. The validationMapper receives the same argument as the filterMapper, namely the request.headers.extraParams object. (if present)

### mongoDB ObjectIDs

All relationships (as defined in the resource definition) in the queries or in the post bodies are cast to valid mongoDB ObjectIDs.

### Usage

```javascript
var MongoStore = require("jsonapi-store-mongodb");

jsonApi.define({
  resource: "comments",
  handlers: new MongoStore({
    url: "mongodb://localhost:27017/jsonapi",
  })
});
```

### Features

 * Search, Find, Create, Delete, Update
 * Efficient lookups via appropriate indexes
 * Database layer filtering, pagination and sorting

### Getting to Production

Getting this data store to production is really simple:

1. Bring up your MongoDB stack.
2. Create any indexes you may need (this is optional, this module will automatically ensure indexes exist on relationships, however you might want to add an index to an attribute you intend on querying aggressively).
3. Deploy your code.
4. Celebrate.

When making schema changes, deploy away and carry on. If the changes aren't backwards compatible, you may want to run a job to ensure all old (existing) records conform to the new schema. If they don't conform to the new schema, they will be dropped by jsonapi-server's validation layer.
